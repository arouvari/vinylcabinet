{% extends "base.html" %}

{% block content %}
<h1>Vinyl Cabinet</h1>

<form method="GET">
    <input type="text" name="query" placeholder="Search" value="{{ query }}">

    <label for="sort">Sort by:</label>
    <select name="sort" id="sort">
        <option value="newest" {% if sort == 'newest' %}selected{% endif %}>Newest First</option>
        <option value="oldest" {% if sort == 'oldest' %}selected{% endif %}>Oldest First</option>
        <option value="title" {% if sort == 'title' %}selected{% endif %}>Title A-Z</option>
        <option value="artist" {% if sort == 'artist' %}selected{% endif %}>Artist A-Z</option>
        <option value="year" {% if sort == 'year' %}selected{% endif %}>Year</option>
        <option value="rating" {% if sort == 'rating' %}selected{% endif %}>Highest Rated</option>
    </select>

    <button type="submit">Search</button>
    {% if query or sort != 'newest' %}
        <a href="/">Clear</a>
    {% endif %}
</form>

{% if albums %}
    <ul>
    {% for album in albums %}
        <li>
            <h3>{{ album['title'] }} by {{ album['artist'] }} ({{ album['year'] }})</h3>
            {% if album['genres'] %}
                <p>Genres: {% for genre in album.genres %}{{ genre.name }}{% if not loop.last %}, {% endif %}{% endfor %}</p>
            {% endif %}
            <p>Added by: <a href="{{ url_for('user_page', username=album['owner_username']) }}">{{ album['owner_username'] }}</a></p>
            {% if album['image_url'] %}
                <img src="{{ album['image_url'] }}" alt="Cover" width="150">
            {% else %}
                <img src="{{ url_for('static', filename='placeholder.jpg') }}" alt="No cover" width="150">
            {% endif %}

            <a href="{{ url_for('album_detail', album_id=album['id']) }}">View Details</a>

            {% if session.user_id %}
                <form method="post" action="{{ url_for('favorite', album_id=album['id']) }}" style="display: inline;">
                    <input type="hidden" name="csrf_token" value="{{ session.csrf_token }}">
                    {% if album.get('is_favorite') %}
                        <button type="submit">★ Unfavorite</button>
                    {% else %}
                        <button type="submit">☆ Favorite</button>
                    {% endif %}
                </form>

                {% if album['user_id'] == session.user_id %}
                    <a href="{{ url_for('edit_album', album_id=album['id']) }}">Edit</a>
                    <form method="post" action="{{ url_for('delete_album', album_id=album['id']) }}" style="display: inline;">
                        <input type="hidden" name="csrf_token" value="{{ session.csrf_token }}">
                        <button type="submit">Delete</button>
                    </form>
                {% endif %}
            {% endif %}

            {% if album.get('avg_stars') %}
                <p>Rating: {{ '★' * (album['avg_stars'] | int) }}{{ '☆' * (5 - (album['avg_stars'] | int)) }}</p>
            {% endif %}
        </li>
    {% endfor %}
    </ul>

    {% if total_pages > 1 %}
    <div class="pagination">
        {% if page > 1 %}
            <a href="?{% if query %}query={{ query }}&{% endif %}{% if sort %}sort={{ sort }}&{% endif %}page={{ page - 1 }}">&laquo; Previous</a>
        {% endif %}

        {% for p in range(1, total_pages + 1) %}
            {% if p == page %}
                <strong>{{ p }}</strong>
            {% elif p == 1 or p == total_pages or (p >= page - 2 and p <= page + 2) %}
                <a href="?{% if query %}query={{ query }}&{% endif %}{% if sort %}sort={{ sort }}&{% endif %}page={{ p }}">{{ p }}</a>
            {% elif p == page - 3 or p == page + 3 %}
                <span>...</span>
            {% endif %}
        {% endfor %}

        {% if page < total_pages %}
            <a href="?{% if query %}query={{ query }}&{% endif %}{% if sort %}sort={{ sort }}&{% endif %}page={{ page + 1 }}">Next &raquo;</a>
        {% endif %}
    </div>
    {% endif %}
{% else %}
    <p>No albums found.</p>
{% endif %}

{% if session.username %}
    <a href="{{ url_for('add') }}">Add New Album</a>
    <a href="{{ url_for('user_page', username=session.username) }}">My Profile</a>
{% endif %}
{% endblock %}